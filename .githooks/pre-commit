#!/bin/sh
SCHEMA_CHANGED=$(git diff --cached --name-only | grep -E "^services/db/src/models/.*\.ts$" || true)

if [ -n "$SCHEMA_CHANGED" ]; then
    echo ""
    echo "üîç Detected schema changes in services/db/src/models/"
    echo "   Changed files:"
    echo "$SCHEMA_CHANGED" | sed 's/^/     - /'
    echo ""

    exec < /dev/tty
    printf "Generate database migration? [Y/n] "
    read -r answer
    exec <&-

    if [ "$answer" != "n" ] && [ "$answer" != "N" ]; then
        echo ""
        echo "üîÑ Generating migration..."

        cd services/db

        if pnpm migrate:generate; then
            echo ""
            echo "‚úÖ Migration generated successfully"

            NEW_MIGRATIONS=$(git status --porcelain migrations/ 2>/dev/null | grep "^??" || true)
            MODIFIED_MIGRATIONS=$(git status --porcelain migrations/ 2>/dev/null | grep "^ M" || true)

            if [ -n "$NEW_MIGRATIONS" ] || [ -n "$MODIFIED_MIGRATIONS" ]; then
                echo "üì¶ Adding migration files to commit..."
                git add migrations/
                echo "‚úÖ Migration files added to commit"
            else
                echo "‚ÑπÔ∏è  No new migration files generated (schema may already be in sync)"
            fi
        else
            echo ""
            echo "‚ùå Migration generation failed!"
            echo "   Please fix the issue and try again."
            exit 1
        fi

        cd - > /dev/null
    else
        echo ""
        echo "‚è≠Ô∏è  Skipping migration generation"
        echo "   Remember to run 'pnpm db:generate' before pushing!"
    fi
fi
